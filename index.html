<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IV-Master Pro V80</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <script>
        // Safe wrappers to avoid ReferenceErrors before script.js initializes
        function safeCreateDemoAHU(){ if (typeof window.createDemoAHU === 'function') { return window.createDemoAHU(); } alert('Demo AHU -funktio ei ole viel√§ ladattu.'); }
        function safeCreateDemoRoof(){ if (typeof window.createDemoRoof === 'function') { return window.createDemoRoof(); } alert('Demo Huippuimuri -funktio ei ole viel√§ ladattu.'); }
        function safeCreateDemoHybrid(){ if (typeof window.createDemoHybrid === 'function') { return window.createDemoHybrid(); } alert('Demo Hybridi -funktio ei ole viel√§ ladattu.'); }
    

        function safeShowVisual(){ if (typeof window.showVisual === 'function') { return window.showVisual(); } alert('Visualisointi ei ole viel√§ ladattu.'); }
    </script>

    <link rel="stylesheet" href="./style.css">
</head>
<body>
    <div class="header">
<button class="back-btn" onclick="goBackToProjects()">‚Üê</button>
        <h1>IV-Master Pro V80</h1>
    </div>

    <!-- PROJECTS VIEW -->
<div class="view active" id="view-projects">
    <div style="padding: 20px;">

        <!-- Uusi projekti -->
        <button
            type="button"
            class="btn btn-primary"
            onclick="showNewProjectModal()">
            + Uusi projekti
        </button>

        <!-- Arkisto -->
        <button
            class="btn btn-secondary"
            style="margin-top:10px;"
            onclick="openArchiveView()">
            üìÅ Arkisto
        </button>

        <!-- Suora s√§√§t√∂ -->
        <button
            class="btn btn-primary"
            onclick="showRelativeAdjustShortcut()"
            style="margin-top:10px;">
            ‚öñÔ∏è Suora s√§√§t√∂
        </button>

        <!-- Ei projekteja -viesti -->
        <div
            id="noProjectsMsg"
            style="text-align:center; color:#999; margin-top:40px;">
            Ei projekteja. Luo uusi!
        </div>

        <!-- Projektien lista -->
        <div id="projectsList"></div>

    </div>
</div>

<!-- ===============================
     ARKISTO
     =============================== -->
<div id="view-project-archive" class="view" style="display:none; padding:16px;">

    <h2 style="margin-bottom:12px;">üìÅ Arkisto</h2>

    <!-- T√§h√§n renderProjectArchive() piirt√§√§ listan -->
    <div id="projectArchiveList"></div>

    <div style="margin-top:20px;">
        <button class="btn btn-secondary"
                onclick="showView('view-projects')">
            ‚Üê Takaisin etusivulle
        </button>
    </div>
</div>

    <!-- DETAILS VIEW -->
    <div class="view" id="view-details">
        <div style="padding: 15px;">
            <h3 id="currentProjectName">Projekti</h3>
              <!-- üîΩ K√ÑYTT√ÑJ√ÑN TILAVIHJE -->
        <div id="workflowHint"
        style="margin:10px 0;padding:10px;border-radius:8px;
               background:#eef2ff;color:#1a237e;
               font-weight:bold;font-size:13px;">
   </div>
            <div id="project-actions" style="display:flex; gap:8px; margin-top:10px; flex-wrap:wrap;">
                <span style="color:red; font-weight:bold;">
    DEBUG: PROJECT ACTIONS HERE
</span>

<button class="btn btn-secondary" onclick="showAddValve('extract')">
    + Lis√§√§ poistoventtiili
</button>                <button class="btn btn-primary" onclick="showVisual()" style="width:auto; padding:8px 12px;">üìä N√§yt√§ kaavio</button>
                <button class="btn btn-secondary" onclick="showRelativeAdjustPanel()" style="width:auto; padding:8px 12px; background-color: #e65100; color: white;">‚öñÔ∏è Suhteellinen s√§√§t√∂</button>
                <button class="btn btn-secondary" onclick="showBalance()" style="width:auto; padding:8px 12px;">‚öñÔ∏è Tasapaino</button>
                <button class="btn btn-secondary" onclick="optimizeEnergy()" style="width:auto; padding:8px 12px;">‚ö° Optimoi</button>
<button class="btn btn-secondary" onclick="openReportView()" style="width:auto; padding:8px 12px;">
    üìÑ P√∂yt√§kirja
</button>
<button class="btn btn-secondary"
        onclick="openKLibraryAdmin()"
        style="width:auto; padding:8px 12px;">
    üìö K-kirjasto
</button>
               <button class="btn btn-secondary" onclick="showReportRoof()" style="width:auto; padding:8px 12px;">üìÑ N√§yt√§ p√∂yt√§kirja: Huippuimuri</button>
                    <button class="btn btn-secondary" onclick="(window.showChart?showChart():alert('Kaavion n√§ytt√∂ ei ole viel√§ k√§ytett√§viss√§'))" style="width:auto; padding:8px 12px;">üìà N√§yt√§ kaavio</button>
                <button class="btn btn-secondary" onclick="showSettings()" style="width:auto; padding:8px 12px;">‚öôÔ∏è Asetukset</button>
            </div>
            <div class="mode-selector" id="modeSelector">
                <button class="mode-btn active" id="btnModeHome" onclick="setMode('home')">Home</button>
                <button class="mode-btn" id="btnModeAway" onclick="setMode('away')">Away</button>
                <button class="mode-btn" id="btnModeBoost" onclick="setMode('boost')">Boost</button>
            </div>

            <div class="copy-controls">
                <div style="font-size:10px; font-weight:bold; padding-top:6px;">KOPIOI TILAAN:</div>
                <button class="copy-btn" onclick="copyModeData('away')">‚Üí Poissa</button>
                <button class="copy-btn" onclick="copyModeData('home')">‚Üí Kotona</button>
                <button class="copy-btn" onclick="copyModeData('boost')">‚Üí Tehostus</button>
            </div>
            
            <h4>IV-Koneet</h4>
            <div style="background:#fff; padding:10px; margin:10px 0; border:1px solid #ccc; border-radius:8px; display:flex; align-items:center; gap:10px;">
                <label style="margin:0; font-weight:bold;">Suodata:</label>
                <select id="apartmentFilter" onchange="renderDetailsList()" style="margin:0; flex:1; font-weight:bold; padding:8px;">
                    <option value="all">N√§yt√§ kaikki</option>
                </select>
            </div>

            <div id="machineList"></div>
            <button class="btn btn-secondary" onclick="showAddMachine()">+ Kone</button>
            
            <h4 style="margin-top: 20px;">Runkokanavat</h4>
            <div id="ductList"></div>
            <button class="btn btn-outline" onclick="showAddDuct()" style="background: transparent; border: 2px solid #ccc; color: #555; margin-top: 10px;">+ Lis√§√§ runkokanava</button>
            
            <h4 style="margin-top: 20px;">Venttiilit</h4>

<div id="valveList">
    <!-- renderDetailsList() t√§ytt√§√§ t√§m√§n -->
</div>
<h4>Mittalista</h4>

<div style="margin-top:8px;">
<button class="btn btn-primary" onclick="showAddValve('supply')">
    + Lis√§√§ tuloventtiili
</button>
</div>

            <button class="btn btn-secondary" style="margin-top:5px;" onclick="showPressureMeasure()">üìè Mittaa paine-ero (Pa)</button>

            <h4 style="margin-top: 20px;">Paine-erot</h4>
            <div id="pressureList"></div>

            <div id="sfpDisplay" style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 8px; font-weight: bold;"></div>
            <button class="btn btn-danger" onclick="deleteCurrentProject()" style="margin-top: 10px;">üóëÔ∏è Poista projekti</button>
        </div>
    </div>

    <!-- VISUAL/SCHEMATIC VIEW -->
    <div class="view" id="view-visual">
        <div style="background:#333; padding:10px; display:flex; gap:10px; position:sticky; top:0; z-index:100;">
            <div id="visModeButtons" style="display:flex; gap:5px; flex:1;">
                <button class="btn btn-secondary" style="margin:0; padding:5px 10px; font-size:12px;" onclick="setVisualMode('vertical')">üè¢ Pysty</button>
                <button class="btn btn-secondary" style="margin:0; padding:5px 10px; font-size:12px;" onclick="setVisualMode('horizontal')">üè† Vaaka</button>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-secondary" style="margin:0; padding:5px 10px;" onclick="zoomVisual(0.1)">üîç+</button>
                <button class="btn btn-secondary" style="margin:0; padding:5px 10px;" onclick="zoomVisual(-0.1)">üîç-</button>
            </div>
        </div>

        <div id="relativeAdjustPanel" style="display: none; padding: 0 15px;"></div>
        <div id="visRoofBar" style="position:sticky; top:46px; z-index:90; background:#fafafa; border-bottom:1px solid #ddd; padding:8px 12px; display:flex; gap:12px; align-items:center;"></div>

        <div id="visScrollArea" style="overflow:auto; height:80vh; background:#eef; position:relative;">
            <div id="visContent" style="transform-origin: 0 0; transition: transform 0.1s ease; padding:50px; min-height:1000px; min-width:1000px;">
            </div>
        </div>
    </div>


    <!-- APARTMENT MODAL -->
    <div class="modal-overlay" id="aptModal" style="display:none;">
        <div class="modal-content" style="width:90%; max-width:500px;">
            <div class="apt-header">
                <span id="aptModalTitle">Asunto</span>
                <button class="clear-sig-btn" onclick="closeApartmentModal()">‚úñ</button>
            </div>
            <div id="aptModalBody" style="padding:10px;">
                <div style="font-size:12px; color:#666; margin-bottom:6px;">Venttiilit</div>
                <table class="report" id="aptValveTable">
                    <thead>
                        <tr>
                            <th>Huone</th><th>Malli</th><th>Pa (Pa)</th><th>Avaus</th><th>Virtaus (l/s)</th><th>Tavoite (l/s)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div style="margin-top:10px; display:flex; gap:6px;">
                    <button class="btn btn-primary" style="width:auto;" onclick="saveApartmentEdits()">Tallenna</button>
                    <button class="btn btn-secondary" style="width:auto;" onclick="closeApartmentModal()">Sulje</button>
                </div>
            </div>
        </div>
    </div>
<!-- ADD K VALUE MODAL (V2 ‚Äì SINGLE ENTRY) -->
<div class="modal-overlay" id="addKModal" style="display:none;">
  <div class="modal-content" style="max-width:720px; width:100%; padding:12px;">

  <h3>‚ûï Lis√§√§ K-arvoja kirjastoon</h3>

  <!-- Perustiedot -->
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px;">
    <select id="addKKind">
      <option value="supply">Tulo</option>
      <option value="extract">Poisto</option>
      <option value="damper">S√§√§din</option>
      <option value="diffuser">Hajottaja</option>
      <option value="other">Muu</option>
    </select>

    <input id="addKModel" placeholder="Malli (esim. Halton KSO)">
    <input id="addKSize" placeholder="Koko (esim. 125)">
    <input id="addKVariant" placeholder="Variantti (valinnainen)">
    <label style="font-size:12px;">Avausv√§li</label>
<input id="addKStep"
       type="number"
       value="1"
       step="0.5"
       style="width:80px;">
<label style="font-size:12px; margin-top:6px;">
  Liit√§ lista (Ctrl+V)
</label>

<textarea
  id="addKPaste"
  rows="4"
  placeholder="Esim:
-15 2.10
-10 2.40
-5  2.80"
  style="width:100%; font-size:12px;"
></textarea>

<button class="btn btn-secondary"
        style="margin-top:4px;"
        onclick="parsePastedKList()">
  üìã Tuo listasta
</button>

  </div>
  

  <!-- Monirivinen sy√∂tt√∂ -->
  <table style="width:100%; font-size:13px; margin-bottom:10px;">
    <thead>
      <tr>
        <th style="text-align:left;">Avaus</th>
        <th style="text-align:left;">K-arvo</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="addKRows"></tbody>
  </table>

  <button class="btn btn-secondary" onclick="addKRow()">‚ûï Lis√§√§ rivi</button>
  <button class="btn btn-secondary"
        onclick="generateIntermediateKRows()">
  ‚öôÔ∏è T√§ydenn√§ v√§liarvot
</button>


  <div style="display:flex; gap:8px; margin-top:12px;">
    <button class="btn btn-primary" onclick="saveKRows()">üíæ Tallenna</button>
    <div style="flex:1;"></div>
    <button class="btn btn-secondary" onclick="closeAddKModal()">Peruuta</button>
  </div>

  <div style="margin-top:8px; font-size:12px; color:#666;">
    ‚ÑπÔ∏è Kaikki lis√§tyt K-arvot tallennetaan odottavina (vaativat hyv√§ksynn√§n).
  </div>

</div>

</div>

<!-- K-LIBRARY GROUP MODAL (monirivi: avaus + K) -->
<div class="modal-overlay" id="klibGroupModal" style="display:none;">
  <div class="modal-content" style="max-width:820px; width:100%; padding:12px;">

    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
      <strong id="klibGroupTitle">Venttiili</strong>
      <div style="flex:1;"></div>

      <button class="btn btn-primary"
              style="font-size:12px;"
              onclick="approveAllInOpenGroup()">
        ‚úÖ Hyv√§ksy kaikki
      </button>

      <button class="btn btn-secondary"
              onclick="closeKLibGroup()">
        ‚úñ Sulje
      </button>
    </div>

    <div id="klibGroupMeta" style="font-size:12px; color:#666; margin-bottom:10px;"></div>

    <!-- lis√§√§ rivi -->
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
      <input id="klibNewPos" class="input" type="number" step="0.1" placeholder="Avaus">
      <input id="klibNewK" class="input" type="number" step="0.01" placeholder="K">
      <button class="btn btn-primary" onclick="addKRowToGroup()">‚ûï Lis√§√§</button>
    </div>

    <div style="overflow:auto; max-height:65vh;">
      <table style="width:100%; border-collapse:collapse; font-size:13px;">
        <thead>
          <tr style="background:#f6f7f9;">
            <th style="padding:8px; text-align:left;">Avaus</th>
            <th style="padding:8px; text-align:left;">K</th>
            <th style="padding:8px;">Tila</th>
            <th style="padding:8px;">P√§ivitetty</th>
            <th style="padding:8px;"></th>
          </tr>
        </thead>
        <tbody id="klibGroupRows"></tbody>
      </table>
    </div>

  </div>
</div>


    <!-- ADD/EDIT MACHINE VIEW -->
    <div class="view" id="view-add-machine">
        <div style="padding: 15px;">
            <h3 id="machineTitle">Uusi IV-Kone</h3>
            <label>Nimi</label>
            <input type="text" id="machineName" placeholder="esim. Vallox 145">

            <label>Yksikk√∂ / Ohjaustapa</label>
            <select id="machineUnit" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;" onchange="updateMachineInputLimits()">
                <option value="pa">Vakiopaine (Pa)</option>
                <option value="hz">Taajuus (Hz)</option>
                <option value="speed">Nopeus / % (Vakionopeus)</option>
            </select>

            <label id="machineValueLabel">Asetusarvo (0-10000 Pa)</label>
            <input type="number" id="machineValue" placeholder="esim. 150">
            <label>Tulo %</label>
            <input type="number" id="machineSupPct" placeholder="50">
            <label>Poisto %</label>
            <input type="number" id="machineExtPct" placeholder="50">
            <label>Tulo l/s (kokonais)</label>
            <input type="number" id="machineSupplyQ" placeholder="100">
            <label>Poisto l/s (kokonais)</label>
            <input type="number" id="machineExtractQ" placeholder="100">
            
            <button class="btn btn-primary" onclick="saveMachine()">Tallenna</button>
        </div>
    </div>
    <!-- MEASUREMENT/VALVE EDIT VIEW -->
    <div class="view" id="view-measure">
        <div style="padding: 15px;">
            <h3 id="measureTitle">Uusi mittaus</h3>
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px; background:#f0f8ff; padding:5px; border-radius:4px;">
                <label style="margin:0; font-weight:bold; min-width:60px;">Asunto:</label>
                <input type="text" id="apartmentName" placeholder="Esim. A1" style="margin:0; flex:1;">
                <label style="margin:0; font-weight:bold; min-width:60px;">Rappu:</label>
                <select id="rappuSelect" style="margin:0; width:90px;"></select>
            </div>
            <label>Huone / Nimi</label>
            <input type="text" id="roomName" placeholder="esim. Olohuone">
            <label>Manuaalinen nimi (valinnainen)</label>
            <input type="text" id="manualName" placeholder="">
            
            <label style="font-weight: bold; margin-top: 15px;">Venttiili</label>
            <label>Malli</label>
            <select id="valveModelSelect" onchange="updateSizeSelect()"></select>
            <label>Koko</label>
            <select id="valveSizeSelect" onchange="finalizeValveSelection()"></select>
            <input type="hidden" id="valveType">
            
            <div id="valveReferenceTable" style="background: #fffacd; padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 12px; display: none;"></div>
            
            
            <label>Tavoitevirta l/s</label>
            <input type="number" id="targetQ" placeholder="15.0">
            
            <label>Mitattu paine Pa</label>
            <input type="number" id="measuredP" placeholder="25">
            <input type="number" id="measuredFlow" placeholder="Virtaus l/s" class="input input-number">
            
            <label>L√§mp√∂tila (¬∞C)</label>
            <input type="number" id="airTemp" value="20" placeholder="20">
            
            <label>Avausaste (0-10, tai pos)</label>
            <input type="number" id="currentPos" step="0.1" oninput="updateLiveK()" placeholder="2.5">
            <div id="liveKValue" style="font-size: 13px; color: #0066cc; font-weight: bold; margin-top: -8px; margin-bottom: 15px;"></div>
            
            <label>Manuaalinen K-arvo (valinnainen)</label>
            <input type="number" id="manualK" step="0.1" placeholder="">
            <button class="btn btn-secondary"
        style="margin-top:6px;"
        onclick="openKLibraryPicker()">
    üîç Hae K-kirjastosta
</button>

            <button class="btn btn-secondary"
        onclick="saveCurrentKToLibrary()"
        style="margin-top:6px;">
    üíæ Tallenna K-kirjastoon
</button>

            <label>Kuva (valinnainen)</label>
            <input type="file" id="valvePhotoInput" accept="image/*" onchange="previewPhoto()">
            <img id="valvePhotoPreview" class="photo-preview">
            
            <button class="btn btn-primary" id="btnCalcSave" onclick="calculateAndSave()">Laske & Tallenna</button>
            <button class="btn btn-secondary" onclick="calculateAndSave(true)" style="margin-top: 10px;">Tallenna & Seuraava</button>
            <button class="btn btn-danger" id="btnDeleteValve" style="margin-top: 10px; display: none;" onclick="deleteValve()">Poista venttiili</button>
            <div id="calcResult" style="display: none; margin-top: 15px; background: #e8f4fd; padding: 15px; border-radius: 8px;"></div>
            <div style="margin-top:15px; display:flex; gap:8px;">
                <button class="btn btn-secondary" onclick="openAddApartmentModal()">Lis√§√§ asunto</button>
            </div>
        </div>
    </div>

    <!-- ADD APARTMENT MODAL -->
    <div class="modal-overlay" id="addApartmentModal" style="display:none;">
        <div class="modal">
            <div class="modal-header">Lis√§√§ asuntoja</div>
            <div class="modal-content">
                <div class="valve-edit-row">
                    <label>Rappu
                        <select id="aptModalRappu" class="input input-sm w-120"></select>
                    </label>
                    <label>Kerros
                        <select id="aptModalKerros" class="input input-sm w-120"></select>
                    </label>
                </div>
                <div class="valve-edit-row">
                    <label>M√§√§r√§ (asunnot)
                        <select id="aptModalCount" class="input input-sm w-120">
                            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>8</option><option>10</option>
                        </select>
                    </label>
                    <label>M√§√§r√§ per rappu
                        <select id="aptModalPerRappu" class="input input-sm w-140">
                            <option>1</option><option>2</option><option>3</option><option>4</option>
                        </select>
                    </label>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="confirmAddApartments()">Luo</button>
<button class="btn btn-cancel" onclick="closeAddApartmentModal()">Peruuta</button>
            </div>
        </div>
    </div>

<!-- ADD DUCT VIEW -->
<div class="view" id="view-add-duct" style="display:none;">
    <button class="btn btn-secondary" onclick="showView('view-details')">Peruuta</button>

    <div style="padding: 15px;">
        <h3>Runko</h3>

        <label>Tyyppi</label>
        <select id="ductType">
            <option value="supply">Tulo</option>
            <option value="extract">Poisto</option>
        </select>

        <label>Nimi</label>
        <input type="text" id="ductName" placeholder="esim. P√§√§runko">

        <label>Koko (mm)</label>
<label>Koko (mm)</label>
<select id="ductSize">
    <option value="">Valitse koko</option>
    <option>80</option>
    <option>100</option>
    <option>125</option>
    <option>160</option>
    <option>200</option>
    <option>250</option>
    <option>315</option>
    <option>400</option>
    <option>500</option>
    <option>630</option>
    <option>800</option>
    <option>900</option>
    <option>1000</option>
    <option>1250</option>
</select>

        <label>Kanavisto</label>
        <select id="ductGroup">
            <option value="ahu">IV-Kone (Tulo/Poisto)</option>
            <option value="roof">Huippuimuri (Poisto)</option>
        </select>

        <button class="btn btn-primary" onclick="saveDuct()">Tallenna</button>
    </div>
</div>
<!-- KLIB DETAIL MODAL -->
<div class="modal-overlay" id="klibDetailModal" style="display:none;">
  <div class="modal-content" style="max-width:900px; width:100%; padding:14px;">

    <!-- Otsikkorivi -->
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
      <div style="font-size:16px; font-weight:800;" id="klibDetailTitle">K-arvot</div>
      <div style="flex:1;"></div>
      <button class="btn btn-secondary" onclick="closeKLibDetail()">Sulje</button>
    </div>

    <!-- Suodatus + toiminnot -->
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
      <label style="cursor:pointer; font-size:13px;">
        <input type="checkbox" id="klibOnlyPending" onchange="renderKLibDetail()">
        N√§yt√§ vain odottavat
      </label>

      <div style="flex:1;"></div>

      <button class="btn btn-primary"
              style="font-size:12px; padding:6px 10px;"
              onclick="klibApproveAllForCurrent()">
        ‚úÖ Hyv√§ksy kaikki
      </button>
    </div>

    <!-- Meta -->
    <div style="font-size:12px; color:#666; margin-bottom:10px;" id="klibDetailMeta"></div>

    <!-- Taulukko -->
    <div style="overflow:auto; border:1px solid #e6e6e6; border-radius:10px;">
      <table class="report" style="width:100%; font-size:13px;">
        <thead>
          <tr>
            <th style="text-align:left;">Avaus</th>
            <th style="text-align:left;">K</th>
            <th style="text-align:left;">Tila</th>
            <th style="text-align:left;">L√§hde</th>
            <th style="text-align:left;">P√§iv√§ys</th>
            <th style="width:1%;"></th>
          </tr>
        </thead>
        <tbody id="klibDetailBody"></tbody>
      </table>
    </div>

  </div>
</div>

  
  </div>
</div>

    <!-- SETTINGS VIEW -->
    <div class="view" id="view-settings">
        <div style="padding: 15px;">
            <h3>Asetukset</h3>
            <label>Mittaaja</label>
            <input type="text" id="setMeasurer" placeholder="Nimi">
            <label>Tulopuhaltimen teho (W)</label>
            <input type="number" id="setPowerSup" placeholder="0">
            <label>Poistopuhaltimen teho (W)</label>
            <input type="number" id="setPowerExt" placeholder="0">
            <label><input type="checkbox" id="chkSwept"> Puhdistettu</label>
            <label><input type="checkbox" id="chkBearSup"> Laakeri tulo OK</label>
            <label><input type="checkbox" id="chkBearExt"> Laakeri poisto OK</label>
            <label>Logo (kuva)</label>
            <input type="file" id="logoUpload" accept="image/*" onchange="handleLogoUpload()">
            <img id="settingsLogoPreview" style="max-height: 80px; margin-top: 10px; display: none; border-radius: 8px;">
            <button class="btn btn-primary" onclick="saveSettings()">Tallenna</button>
            <hr style="margin:20px 0;">

<h4>Yll√§pito</h4>

<button class="btn btn-secondary"
        onclick="openKLibraryAdmin()">
    üìö K-kirjasto (Admin)
</button>

        </div>
    </div>
<!-- K-LIBRARY ADMIN VIEW -->
<div class="view" id="view-klib-admin" style="display:none;">
  <div style="padding:12px; max-width:1200px; margin:0 auto;">

    <!-- YL√ÑRIVI -->
<div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">

  <button class="btn btn-secondary"
          onclick="showView('view-details')">
      ‚Üê Takaisin
  

  <div style="flex:1;">
    <div style="font-size:16px; font-weight:800;">üìö K-kirjasto</div>
    <div style="font-size:12px; color:#666;">
      Haku + kansiot (mobiiliyst√§v√§llinen)
    </div>
  </div>

  <button class="btn btn-secondary"
          title="P√§ivit√§"
          onclick="renderKLibraryAdmin()">
      üîÑ
  </button>

 <button class="btn btn-primary"
        onclick="openAddKModal()">
  ‚ûï Lis√§√§ K-arvo
</button>


</div>

    <!-- HAKU -->
    <div style="display:flex; gap:8px; margin-bottom:10px;">
      <input
        id="klibSearch"
        type="text"
        placeholder="Hae: Halton KSO 125, variantti, huom‚Ä¶"
        style="flex:1; padding:10px; border:1px solid #ddd; border-radius:10px; font-size:14px;"
      />
    </div>

    <!-- KANSIOT / KATEGORIAT -->
    <div style="display:flex; gap:8px; margin-bottom:10px; overflow:auto; padding-bottom:4px;">
      <button class="btn btn-secondary" style="white-space:nowrap;" onclick="window.uiState=window.uiState||{}; window.uiState.klibCategory='valve'; renderKLibraryAdmin();">Venttiilit</button>
      <button class="btn btn-secondary" style="white-space:nowrap;" onclick="window.uiState=window.uiState||{}; window.uiState.klibCategory='damper'; renderKLibraryAdmin();">S√§√§timet</button>
      <button class="btn btn-secondary" style="white-space:nowrap;" onclick="window.uiState=window.uiState||{}; window.uiState.klibCategory='diffuser'; renderKLibraryAdmin();">Hajottajat</button>
      <button class="btn btn-secondary" style="white-space:nowrap;" onclick="window.uiState=window.uiState||{}; window.uiState.klibCategory='other'; renderKLibraryAdmin();">Muut</button>
      <button class="btn btn-secondary" style="white-space:nowrap;" onclick="window.uiState=window.uiState||{}; window.uiState.klibCategory='all'; renderKLibraryAdmin();">Kaikki</button>
    </div>

    <!-- INFO -->
    <div id="klibAdminInfo" style="font-size:12px; color:#666; margin-bottom:10px;"></div>

    <!-- KORTTILISTA -->
    <div id="klibAdminCards" style="display:flex; flex-direction:column; gap:10px;"></div>

  </div>
</div>


    


    <!-- REPORT VIEW -->
    <div class="view" id="view-report">
        <div style="padding:0;">

    <!-- RAPORTIN YL√ÑPALKKI -->
    <div id="report-toolbar"
         style="
            display:flex;
            align-items:center;
            gap:8px;
            padding:10px 15px;
            border-bottom:1px solid #ddd;
            background:#f9f9f9;
         ">

        <button class="btn btn-secondary"
                onclick="showView('view-details')">
            ‚Üê Takaisin
        </button>

        <div style="flex:1;"></div>

        <button class="btn btn-secondary"
                onclick="exportUnifiedReportToExcel()">
            üìä Excel
        </button>

        <!-- VARAUKSET MY√ñHEMMIN -->
        <button class="btn btn-secondary" disabled>üìÑ PDF</button>
        <button class="btn btn-secondary" disabled>üì§ L√§het√§</button>

    </div>

    <!-- RAPORTIN SIS√ÑLT√ñ -->
    <div style="padding:15px;">

            <h3>Mittausraportti</h3>
            <img id="reportLogoImg" style="max-height: 50px; max-width: 150px; display: none; margin-bottom: 10px;">
            <div id="reportContent"></div>
            <label>Allekirjoitus</label>
            <div class="signature-wrapper">
                <canvas id="signaturePad"></canvas>
                <button class="clear-sig-btn" onclick="clearSignature()">Tyhjenn√§</button>
            </div>
            <button class="btn btn-primary" onclick="printReport()" style="margin-top: 15px;">üñ®Ô∏è Tulosta</button>
        </div>
    </div>

    <!-- OPTIMIZE VIEW -->
    <div class="view" id="view-optimize">
        <div style="padding: 15px;">
            <h3>‚ö° Optimointiraportti</h3>
            <div id="optSteps" style="background: #f9f9f9; padding: 15px; border-radius: 8px;"></div>
<button class="btn btn-cancel" onclick="showView('view-details')" style="margin-top: 15px;">Takaisin</button>
        </div>
    </div>

    <!-- BALANCE VIEW -->
    <div class="view" id="view-balance">
        <div style="padding: 15px;">
            <h3>‚öñÔ∏è Ilmanvaihdon tasapaino</h3>
            <div id="balanceContent"></div>
<button class="btn btn-cancel" onclick="showView('view-details')" style="margin-top: 15px;">Takaisin</button>
        </div>
    </div>

    <!-- BATCH INPUT VIEW -->
    <div class="view" id="view-batch">
        <div style="padding: 15px;">
            <h3>üìù Sarjasy√∂tt√∂</h3>
            <div id="batchDuctName" style="font-weight: bold; margin-bottom: 15px;"></div>
            
            <label>Valitse venttiilimalli</label>
            <select id="batchNewModel" onchange="updateBatchSizeSelect()"></select>
            
            <label>Koko</label>
            <select id="batchNewSize"></select>
            
            <label>Montako venttiili√§</label>
            <input type="number" id="batchNewCount" min="1" value="1">
            
            <button class="btn btn-secondary" onclick="addBatchValves()">Lis√§√§</button>
            
            <label style="margin-top: 20px;">L√§mp√∂tila (¬∞C)</label>
            <input type="number" id="batchTemp" value="20">
            <button class="btn btn-secondary" onclick="recalcAllBatch()">Laske uudelleen</button>
            
            <div id="batchList" style="margin-top: 15px; overflow-x: auto;"></div>
            
            <button class="btn btn-primary" onclick="saveBatch()">Tallenna kaikki</button>
        </div>
    </div>

    <!-- PRESSURE MEASUREMENT VIEW -->
    <div class="view" id="view-pressure">
        <div class="card">
            <h3>üìè Paine-ero mittaus</h3>
            <label>Mittauksen kohde</label>
            <input type="text" id="pressureName" placeholder="Esim. Ulko-ovi, Postiluukku">
            
            <label>Paine-ero (Pa)</label>
            <div style="color:#666; font-size:11px; margin-bottom:5px;">(- = alipaine, + = ylipaine)</div>
            <input type="number" id="pressureValue" placeholder="-5">
            
            <button class="btn btn-primary" onclick="savePressureDiff()">Tallenna</button>
            <button class="btn btn-secondary" onclick="showView('view-details')">Peruuta</button>
        </div>
    </div>

    <button class="fab" onclick="safeShowVisual()">üìä</button>
    <div id="newProjectModal" class="modal-overlay">
    <div class="modal">

            <h3>Uusi projekti</h3>
            
            <label>Kohteen nimi</label>
            <input type="text" id="newProjName" placeholder="Esim. As Oy Esimerkki">
            
            <label>J√§rjestelm√§n tyyppi</label>
            <select id="newProjType">
                <option value="ahu">üè† IV-Kone (Tulo & Poisto)</option>
                <option value="roof">üí® Huippuimuri (Vain Poisto)</option>
                <option value="hybrid">üîÑ Molemmat / Hybridi</option>
                <option value="kerrostalo">üè¢ Kerrostalo (AHU per asunto)</option>
            </select>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
<button
    type="button"
    class="btn btn-primary"
    onclick="confirmCreateProject()">
    Luo kohde
</button>



                <button class="btn btn-secondary" onclick="closeModal()">Peruuta</button>
            </div>
        </div>
    </div>
<!-- K-LIBRARY DETAIL MODAL -->
<div class="modal-overlay" id="klibDetailModal" style="display:none;">
  <div class="modal-content" style="max-width:720px; width:100%; padding:12px;">
<!-- K-LIBRARY GROUP MODAL (monirivi: avaus + K) -->
<div class="modal-overlay" id="klibGroupModal" style="display:none;">
  <div class="modal-content" style="max-width:820px; width:100%; padding:12px;">

    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
  <strong id="klibGroupTitle">Venttiili</strong>
  <div style="flex:1;"></div>

  <button class="btn btn-primary"
          style="font-size:12px;"
          onclick="approveAllInOpenGroup()">
    ‚úÖ Hyv√§ksy kaikki
  </button>

  <button class="btn btn-secondary"
          onclick="closeKLibGroup()">
    ‚úñ Sulje
  </button>
</div>


    <div id="klibGroupMeta" style="font-size:12px; color:#666; margin-bottom:10px;"></div>

    <!-- monilis√§ys -->
    <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
      <input id="klibNewPos" class="input" type="number" step="0.1" placeholder="Avaus">
      <input id="klibNewK" class="input" type="number" step="0.01" placeholder="K-arvo">
      <button class="btn btn-primary" onclick="addKRowToGroup()">‚ûï Lis√§√§ rivi</button>
    </div>

    <table style="width:100%; font-size:13px;">
      <thead>
        <tr>
          <th style="text-align:left;">Avaus</th>
          <th style="text-align:left;">K</th>
          <th style="text-align:center;">Tila</th>
          <th style="text-align:left;">P√§ivitetty</th>
          <th style="text-align:right;">Toiminnot</th>
        </tr>
      </thead>
      <tbody id="klibGroupRows"></tbody>
    </table>

  </div>
</div>

    <!-- OTSIKKO -->
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
      <strong id="klibDetailTitle" style="font-size:16px;">Venttiili</strong>
      <div style="flex:1;"></div>
      <button class="btn btn-secondary" onclick="closeKLibDetail()">‚úñ</button>
    </div>

    <!-- VAROITUS -->
    <div id="klibDetailWarning"
         style="display:none; margin-bottom:8px; padding:8px; border-radius:8px; background:#fff3cd; color:#856404; font-size:13px;">
      ‚ö†Ô∏è Useita K-arvoja t√§lle venttiilille. K√§yt√∂ss√§ on viimeisin hyv√§ksytty.
    </div>

    <!-- LISTA -->
    <div id="klibDetailList" style="display:flex; flex-direction:column; gap:8px;"></div>

    <!-- TOIMINNOT (UI only) -->
    <div style="display:flex; gap:8px; margin-top:10px;">
      <button class="btn btn-primary" onclick="alert('Lis√§ys tehd√§√§n seuraavassa vaiheessa')">‚ûï Lis√§√§ K-arvo</button>
      <div style="flex:1;"></div>
      <button class="btn btn-secondary" onclick="closeKLibDetail()">Sulje</button>
    </div>

  </div>
</div>

    <!-- GENERAATTORIN MODAALI -->
    <div id="genModal" class="modal-overlay">
        <div class="modal-content">
            <h3>üè¢ Luo asuntoja</h3>
            <p style="font-size:12px; color:#666;">Luo monta asuntoa kerralla.</p>
            <div class="gen-row"><label>Kerroksia:</label> <input type="number" id="genFloors" value="3"></div>
            <div class="gen-row"><label>Asuntoja / krs:</label> <input type="number" id="genApts" value="4"></div>
            <div class="gen-row"><label>Aloitusnro:</label> <input type="number" id="genStart" value="1"></div>
            <div class="gen-row"><label>Tunnus (A,B..):</label> <input type="text" id="genPrefix" value="A" style="width:60px;"></div>
            <hr style="border:1px solid #eee; margin:10px 0;">
            <label style="font-weight:bold;">Sis√§lt√∂ per asunto:</label>
            <div class="chk-row"><input type="checkbox" id="chkK" checked> <label>Keitti√∂</label></div>
            <div class="chk-row"><input type="checkbox" id="chkKPH" checked> <label>KPH</label></div>
            <div class="chk-row"><input type="checkbox" id="chkVH"> <label>VH</label></div>
            <div class="chk-row"><input type="checkbox" id="chkFresh"> <label>Korvausilma (Venttiili)</label></div>
            <div class="chk-row"><input type="checkbox" id="chkWC"> <label>WC</label></div>
            <div class="chk-row"><input type="checkbox" id="chkMH"> <label>Makuuhuone</label></div>
            <div class="chk-row"><input type="checkbox" id="chkOH"> <label>Olohuone</label></div>
            <div class="chk-row"><input type="checkbox" id="chkSA"> <label>Sauna</label></div>
            <div class="chk-row"><input type="checkbox" id="chkKHH"> <label>Kodinhoitohuone</label></div>
            <hr style="border:1px solid #eee; margin:10px 0;">
            <label style="font-weight:bold;">Manuaalinen lis√§ys:</label>
            <div class="gen-row">
                <label>Huoneen nimi:</label>
                <input type="text" id="genCustomName" placeholder="esim. Sauna2" style="width:120px;">
            </div>
            <div class="gen-row">
                <label>Tyyppi:</label>
                <select id="genCustomType" style="width:120px;">
                    <option value="extract">Poisto</option>
                    <option value="supply">Tulo/Korvausilma</option>
                </select>
            </div>
            <div class="gen-row">
                <label>Malli/koko:</label>
                <select id="genCustomModel" style="width:160px;">
                    <option value="h_kso100">KSO-100 (poisto)</option>
                    <option value="h_kso125">KSO-125 (poisto)</option>
                    <option value="fresh100">Fresh-100 (tulo)</option>
                    <option value="fresh125">Fresh-125 (tulo)</option>
                </select>
            </div>
            <div class="chk-row"><input type="checkbox" id="chkCustom"> <label>Lis√§√§ t√§m√§ huone joka asuntoon</label></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-success" onclick="runGenerator()">Luo asunnot</button>
<button class="btn btn-cancel" onclick="closeGenerator()">Peruuta</button>
            </div>
        </div>
    </div>
    <div id="ductMeasureModal" class="modal-overlay" style="display:none;">
        <div class="modal">
            <div class="modal-header">Mittaa runkokanava (Pitot)</div>
            <div class="modal-content">
                <input type="hidden" id="measureDuctId">
                <p style="font-size:12px; color:#666; margin-bottom:10px;">
                    Sy√∂t√§ t√§h√§n rungosta mitattu todellinen virtaus. Ohjelma vertaa t√§t√§ venttiilien summaan.
                </p>
                <label>Mitattu virtaus (l/s)</label>
                <input type="number" id="ductMeasuredFlow" class="input input-number" placeholder="0.0" step="0.1">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveDuctMeasurement()">Tallenna</button>
                <button class="btn btn-secondary" onclick="closeDuctMeasureModal()">Peruuta</button>
                <button class="btn btn-danger" onclick="clearDuctMeasurement()" style="margin-left:auto;">Nollaa</button>
            </div>
        </div>
    </div>
    

        <div class="modal-content" id="kLibraryContent">
            <!-- t√§ytet√§√§n JS:ll√§ -->
        </div>

        <div class="modal-actions">
<button class="btn btn-cancel" onclick="closeKLibraryModal()">Sulje</button>
        </div>
    </div>



    <!-- Poistettu duplikaatti Asunto-modal (aptModal) -->
     <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <script src="./script.js"></script>
</body>
</html>
<!-- Build: 2025-12-06  | Commit marker: KTS/KSO demo update -->
